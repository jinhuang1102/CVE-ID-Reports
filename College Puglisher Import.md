# College publisher Import <= 0.1 Authenticated Arbitrary File Upload

The vulnerable plugin, College Publisher Import(0.1), is free to download in the wordpress.org.
A user having admin privilege could upload any executable file by the file upload form in this plugin.

```php
<?php

function save_uploaded_file() {
	// get the wordpress upload directory path.
	$upload_dir = wp_upload_dir();
	
	if ( ! empty( $_FILES['csvfile'] ) ) {
		$myFile = $_FILES['csvfile'];
		if ( UPLOAD_ERR_OK !== $myFile['error'] ) {
			throw_error( '<p>Failed to upload file. Please try again.</p>' );
		}
		
		// ensure a safe filename
		$name = preg_replace( "/[^A-Z0-9._-]/i", "_", $myFile['name'] );
		
		$parts = pathinfo( $name );
		$name = $parts['filename'] . "-" . date( "Ymd-His" ) . "." . $parts['extension'];
		
		$dir_path = $upload_dir['basedir'] . '/cp_imported_csv';
		$file_path = $dir_path . '/' . $name;
		
		// Create a directory if we do not have one to store uploaded file
		if ( ! file_exists( $dir_path ) ) {
			if( ! mkdir( $dir_path, 0777, true ) ) {
				$msg = '<p>Failed to create upload folder "'. $dir_path .'". Make sure all permissions are correct.</p>';
				throw_error( $msg );
			}
		}
		
		// preserve file from temporary directory
		$success = move_uploaded_file( $myFile["tmp_name"], $file_path );
		if ( ! $success ) {
			$msg = '<p>Failed to save file in "' . $dir_path . '/". Make sure all permissions are correct.</p>';
			throw_error( $msg );
		}
		
		return $file_path;
	} else {
		throw_error( '<p>Failed to upload file. Please try again.</p>' );
	}
}


```