# Ads EZ Lite <= 3.20 Authenticated Arbitrary File Upload

The plugin Ads EZ Lite provide a personal and powerful Ad server for the user and support a simplest possible way 
to serve the ads to multiple web page.
The plugin intends to support the upload of images and valid image file if a non-image file is supplied, 
but a mis-used API "getimagesize()" rooted the vulnerability of arbitrary file upload. 
The following listing presents the vulnerable code snippet.
```php
<?php
$ds = DIRECTORY_SEPARATOR;
$targetPath = dirname(dirname(__DIR__)) . $ds . "banners" . $ds;  //4
if (!empty($_FILES)) {
    $tempFile = $_FILES['file']['tmp_name'];
    if (getimagesize($tempFile) === false) {
        http_response_code(400);
        $error = "{$_FILES['file']['name']}: Not allowed.";
        die($error);
    }
    $targetFile = $targetPath . $_FILES['file']['name'];
    if (!@move_uploaded_file($tempFile, $targetFile)) {
        http_response_code(400);
        die("File move error: {$_FILES['file']['name']} to $targetFile");
    }
}
```
This mis-used have already cautioned in the [PHP manual](https://www.php.net/manual/en/function.getimagesize.php#:~:text=in%20image_info%20parameter.-,Caution,-This%20function%20expects).
This function is for obtaining the size of an image and more information in image_info parameter rather than checking
that a given file is a valid image. Therefore, a file with the executable ".php" extension can still be uploaded.

