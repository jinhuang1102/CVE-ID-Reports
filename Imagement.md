# Imagements <= 1.2.5 - Arbitrary File Upload
The Wordpress Plugin "Imagements(1.2.5)" is suffered the Arbitrary File Upload vulnerability. It support a visitor to leave 
an image-based comment in user's blogs. The following figure presents the code snippet that introduces th vulnerability. 
The function `imagements_formverwerking()` intends to permanently store a uploaded file in the server. The developer was 
aware of the file type sanitization, however, the filter is fundamentally flawed. It investigates `$_FILES['image']['name']`, 
which is the type of th file offered by the clint side. Since an attacker have full control, so attacker can upload a PHP
executable script and meanwhile intercept the post form to change the file type to "image/png", successfully bypass the 
filter.

```php
<?php
add_action(’comment_post’, ’imagements_formverwerking’);
add_filter(’preprocess_comment’, ’imagements_verify_post_data’);

function imagements_verify_post_data($commentdata) //this function checks if the input in the comment form is valid for this plugin
{
    //...
    if (!($_FILES['image']['type'] == 'image/x-png' ||
          $_FILES['image']['type'] == 'image/pjpeg' ||
          $_FILES['image']['type'] == 'image/jpeg' ||
          $_FILES['image']['type'] == 'image/jpg' ||
          $_FILES['image']['type'] == 'image/png'))
    {
        wp_die(__('this file is no image. Hit the Back button on your Web browser and try again'));
    } 
}

function imagements_formverwerking() //this function handles the file uploading from the comment form
{
    if (isset($_POST['checkbox'])) {
        $name = $_FILES['image']['name'];
        $hash = hash_file("md5", $_FILES['image']['tmp_name']);
        move_uploaded_file($_FILES["image"]["tmp_name"], PATH . '/images/' . $name);
        //...
    }
}
```

[Proof of Video]()