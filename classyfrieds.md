# classyfrieds <= 3.8 Authenticated Arbitrary File Upload

The plugin classyfrieds provide a classifieds system for its user and allowing user having admin privilege account to upload 
image file such as gif, jpeg, jpg, or png. The developer seems aware of the file type sanitization and add a filter to abort any uploading
action if it submits a not image file. However, the added filter only investigates file type `$_FILES['foto']['type']`, 
which is the type of the file derived from client's request. Because an attacker have full control the browser, she can
upload a PHP executable script and instruments the browser to change the `$_FILES['foto']['type']` to 'image/gif', successfully 
bypassing th filter.

```php
<?php
//classyfried/themefiles/page-classyfried_add_listing.php line No. 55

if ($_FILES['foto']['error'] == "0") {
    if (($_FILES['foto']['size'] < 2000000) &&
        ($_FILES['foto']['type'] == 'image/gif' ||
            $_FILES['foto']['type'] == 'image/jpeg' ||
            $_FILES['foto']['type'] == 'image/jpg' ||
            $_FILES['foto']['type'] == 'image/png')
    ) {
        $image = 1;
    } else {
        $error .= $cfl[nopic];
    }
}
```

Once the attacker bypass the file filter the uploading file will be storage to the local directory `..uploads/classyfrieds/...` 
without any restriction.

```php
<?php
//classyfried/themefiles/page-classyfried_add_listing.php line No. 87

if ($image == 1) {
    /*...*/
    if (empty($error)) {
        move_uploaded_file($_FILES["foto"]["tmp_name"], $uploads['basedir'] . 
            "/classyfrieds/" . $current_user->user_login . "/" . 
            str_replace(" ", "-", $_FILES["foto"]["name"]));
    }
}

```